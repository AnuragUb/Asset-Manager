import{showView}from"./utils.js?v=2.5";import{renderDashboard,setupDashboard}from"./dashboard.js?v=2.5";import{renderAdmin}from"./admin.js?v=2.5";import{renderItAssets}from"./itAssets.js?v=2.5";import{setupAuth}from"./auth.js?v=2.5";import{setupQrGenerator}from"./qr.js?v=2.5";console.log("Main.js loading (v2.5)...");let assets=[];async function loadAssets(){console.log("loadAssets() called");try{const response=await fetch("/api/assets");if(response.ok){const data=await response.json();console.log("Raw assets from backend:",data.length);const processedAssets=data.map(a=>({...a,Name:a.Type||a.ItemName,Status:a.Status||"In Store"}));assets=processedAssets;window.allAssets=processedAssets;console.log("Processed assets:",assets.length)}else{console.error("Failed to load assets, status:",response.status)}}catch(err){console.error("Failed to load assets:",err)}}async function saveAsset(asset){console.log("saveAsset() called for:",asset.ItemName||asset.Name);try{const response=await fetch("/api/assets",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(asset)});if(response.ok){console.log("Asset saved successfully");await loadAssets();renderDashboard(assets,filteredAssets)}else{const errText=await response.text();console.error("Failed to save asset, status:",response.status,errText);alert("Error saving asset: "+errText)}}catch(err){console.error("Failed to save asset:",err);alert("Error saving asset: "+err.message)}}window.saveAsset=saveAsset;let currentUser=null;let filteredAssets=()=>{const selectedCategory=localStorage.getItem("selectedAssetCategory");console.log("Filtering assets for category:",selectedCategory);if(!selectedCategory)return assets;const filtered=assets.filter(a=>a.Category===selectedCategory);console.log(`Found ${filtered.length} assets for category ${selectedCategory}`);return filtered};document.addEventListener("DOMContentLoaded",()=>{console.log("DOM Content Loaded (main.js)");const views=document.querySelectorAll(".view");console.log(`Found ${views.length} views`);setupQrGenerator();setupAuth(async user=>{console.log("Login success callback triggered in main.js for user:",user.username);currentUser=user;const appTitle=document.querySelector(".app-title");if(appTitle&&user.category){appTitle.textContent=`${user.category} Asset Manager`}const userNameDisplay=document.getElementById("display-username");if(userNameDisplay&&user.username){userNameDisplay.textContent=user.username}await loadAssets();setupDashboard();setupDashboardFormHandlers();const dashboardView=document.getElementById("dashboardView");if(dashboardView){console.log("Found dashboardView, switching...");showView("dashboardView");renderDashboard(assets,filteredAssets)}else{console.error("Could NOT find dashboardView element!");alert("Error: Dashboard view not found in the page.")}})});function setupDashboardFormHandlers(){console.log("setupDashboardFormHandlers() called");const addAssetKindForm=document.getElementById("addAssetKindForm");if(addAssetKindForm){addAssetKindForm.onsubmit=async e=>{e.preventDefault();console.log("addAssetKindForm submitted");const name=document.getElementById("newKindName").value;const icon=document.getElementById("newKindIcon").value||"ðŸ“¦";const category=localStorage.getItem("selectedAssetCategory");const newAsset={Type:name,Name:name,Icon:icon,Category:category,isPlaceholder:true};await saveAsset(newAsset);const modal=document.getElementById("addAssetKindModal");if(modal)modal.style.display="none";addAssetKindForm.reset()}}const addAssetItemForm=document.getElementById("addAssetItemForm");if(addAssetItemForm){addAssetItemForm.onsubmit=async e=>{e.preventDefault();console.log("addAssetItemForm submitted");const kind=document.getElementById("itemKind").value;const name=document.getElementById("itemName").value;const status=document.getElementById("itemStatus").value;const category=localStorage.getItem("selectedAssetCategory");const kindDef=assets.find(a=>a.Type===kind&&(a.isPlaceholder===true||a.isPlaceholder===1||a.isPlaceholder==="true"));const icon=kindDef?kindDef.Icon:"ðŸ“¦";const newItem={Type:kind,ItemName:name,Status:status,Icon:icon,Category:category,Make:document.getElementById("itemMake").value,Model:document.getElementById("itemModel").value,SrNo:document.getElementById("itemSrNo").value,CurrentLocation:document.getElementById("itemLocation").value,IN:document.getElementById("itemIn").value,OUT:document.getElementById("itemOut").value,Balance:document.getElementById("itemBalance").value,DispatchReceiveDt:document.getElementById("itemDate").value,PurchaseDetails:document.getElementById("itemPurchase").value,Remarks:document.getElementById("itemRemarks").value};await saveAsset(newItem);const modal=document.getElementById("addAssetItemModal");if(modal)modal.style.display="none";addAssetItemForm.reset()}}}
